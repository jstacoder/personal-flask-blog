from flask import jsonify, Blueprint
from flask.views import MethodView

from ..models.comment import Comment
from ..models.blog import Blog
from ..views.generic import ListObjectView

CommentBlueprint = Blueprint('comment', __name__)

class GetCommentByIdView(MethodView):
    def get(self, comment_id):
        return Comment.query.filter(id=comment_id).one()


class ListCommentView(ListObjectView):
    model = Comment
    object_context_name = 'comments'

    def get_json(self, obj):
        return {
            'text': obj.text,
            'author': obj.author.emails[0].email,
            'blog': obj.blog.title
        }

class ListBlogComments(ListObjectView):
    object_context_name = 'comments'
    def get_default_query(self):
        return Blog.query(Blog).filter_by(id=self.kwargs.get("blog_id")).one().comments


CommentBlueprint.add_url_rule(
        "/<comment_id>", 
        view_func=GetCommentByIdView.as_view('get_comment')
)

CommentBlueprint.add_url_rule(
        "/",
        view_func=ListCommentView.as_view('list_comments')
)

CommentBlueprint.add_url_rule(
        '/blog/<blog_id>/',
        view_func=ListBlogComments.as_view('list_blog_comments')
)

